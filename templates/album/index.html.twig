{% extends 'base.html.twig' %}

{% block title %}My Albums{% endblock %}

{% block body %}
<div class="max-w-7xl mx-auto py-10 px-4">
    <!-- Header Section -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <div>
            <h1 class="text-4xl font-bold text-space-cadet mb-2 font-poppins"
                style="font-family: 'Poppins', sans-serif; font-weight: 600;">
                My Albums
            </h1>
            <p class="text-slate-gray font-inter"
               style="font-family: 'Inter', sans-serif; font-weight: 400;">
                Manage your photo albums and collections
            </p>
        </div>

        <a href="{{ path('app_album_new') }}"
           class="bg-vivid-sky-blue hover:bg-blue-600 transition-all shadow-lg transform hover:-translate-y-1
                  text-space-cadet px-6 py-3 rounded-full font-semibold">
            <i class="fas fa-plus mr-2"></i>Create New Album
        </a>
    </div>

    <!-- Search Bar -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
        <div class="relative max-w-md">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-slate-gray"></i>
            </div>
            <input type="text"
                   id="albumSearch"
                   placeholder="Search albums..."
                   class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-full
                          focus:ring-2 focus:ring-vivid-sky-blue focus:border-vivid-sky-blue
                          focus:outline-none transition-colors">
        </div>
    </div>

    <!-- Albums Grid -->
    <div class="bg-white rounded-2xl shadow-xl p-6">
        {% if albums is not empty %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="albumsGrid">
                {% for album in albums %}
                    <div class="album-card bg-gray-50 rounded-lg overflow-hidden shadow hover:shadow-lg
                                transition-all duration-300 hover:transform hover:-translate-y-1 cursor-pointer"
                         data-title="{{ album.title|lower }}"
                         data-status="{{ album.isPublic ? 'public' : 'private' }}"
                         onclick="if (!event.target.closest('.relative') && !event.target.closest('button') && !event.target.closest('a')) { window.location.href = '{{ path('app_album_show', {'id': album.id}) }}'; }"

                        <!-- Album Thumbnail -->
                        <div class="aspect-video bg-gray-200 relative overflow-hidden">
                            {% set albumPhotos = album.photos|slice(0, 1) %}
                            {% if albumPhotos is not empty %}
                                <img src="{{ asset(albumPhotos[0].src) }}"
                                     alt="{{ album.title }}"
                                     class="w-full h-full object-cover">
                            {% else %}
                                <div class="w-full h-full flex items-center justify-center text-gray-400">
                                    <i class="fas fa-images text-4xl"></i>
                                </div>
                            {% endif %}

                            <!-- Status Badge -->
                            <div class="absolute top-3 right-3">
                                {% if album.isPublic %}
                                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">
                                        Public
                                    </span>
                                {% else %}
                                    <span class="px-2 py-1 bg-gray-200 text-gray-700 text-xs font-semibold rounded-full">
                                        Private
                                    </span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Album Info -->
                        <div class="p-4">
                            <h3 class="font-bold text-lg text-space-cadet mb-2 font-poppins"
                                style="font-family: 'Poppins', sans-serif; font-weight: 600;">
                                {{ album.title }}
                            </h3>

                            {% if album.description %}
                                <p class="text-slate-gray text-sm mb-3 line-clamp-2">
                                    {{ album.description }}
                                </p>
                            {% endif %}

                            <div class="flex items-center justify-between text-sm text-slate-gray mb-4">
                                <div class="flex items-center">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    <span>{{ album.createdAt|date('M j, Y') }}</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-camera mr-1"></i>
                                    <span>{{ album.photos|length }} photos</span>
                                </div>
                            </div>

                            <!-- Action Dropdown Menu -->
                            {# <div class="relative">
                                <button onclick="toggleDropdown({{ album.id }})"
                                        class="text-slate-gray hover:text-space-cadet transition-colors p-2 rounded-full
                                               hover:bg-gray-100"
                                        title="Album Actions">
                                    <i class="fas fa-ellipsis-v text-lg"></i>
                                </button>

                                <!-- Dropdown Menu -->
                                <div id="dropdown-{{ album.id }}"
                                     class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200
                                            z-10 hidden">
                                    <div class="py-2">
                                        <!-- View Option -->
                                        <a href="{{ path('app_album_show', {'id': album.id}) }}"
                                           class="flex items-center px-4 py-2 text-sm text-slate-gray
                                                  hover:bg-gray-50 hover:text-space-cadet transition-colors">
                                            <i class="fas fa-eye mr-3 text-vivid-sky-blue"></i>
                                            View Album
                                        </a>

                                        <!-- Edit Option -->
                                        <a href="{{ path('app_album_edit', {'id': album.id}) }}"
                                           class="flex items-center px-4 py-2 text-sm text-slate-gray
                                                  hover:bg-gray-50 hover:text-space-cadet transition-colors">
                                            <i class="fas fa-edit mr-3 text-slate-gray"></i>
                                            Edit Album
                                        </a>

                                        <!-- Delete Option -->
                                        <button onclick="confirmDelete({{ album.id }}, '{{ album.title }}', '{{ csrf_token('delete' ~ album.id) }}')"
                                                class="flex items-center w-full px-4 py-2 text-sm text-red-600
                                                       hover:bg-red-50 transition-colors">
                                            <i class="fas fa-trash-alt mr-3"></i>
                                            Delete Album
                                        </button>
                                    </div>
                                </div>
                            </div> #}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="text-center py-16">
                <div class="text-6xl mb-4 text-gray-300">
                    <i class="fas fa-images"></i>
                </div>
                <h3 class="text-xl font-semibold text-space-cadet mb-2">No albums yet</h3>
                <p class="text-slate-gray mb-6">Start building your photography portfolio by creating your first album.</p>
                <a href="{{ path('app_album_new') }}"
                   class="bg-accent-coral text-white px-6 py-3 rounded-full font-semibold
                          hover:bg-red-500 transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-1 inline-block"
                   style="background-color: #FF6B6B;">
                    <i class="fas fa-plus mr-2"></i>Create Your First Album
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="text-5xl text-red-500 mb-4">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="text-xl font-bold text-space-cadet mb-2">Delete Album?</h3>
                <p class="text-slate-gray mb-2">
                    Are you sure you want to delete
                    <span id="deleteAlbumTitle" class="font-semibold text-space-cadet"></span>?
                </p>
                <p class="text-sm text-slate-gray mb-6">
                    This action cannot be undone. All photos in this album will also be deleted.
                </p>

                <div class="flex gap-3 justify-center">
                    <button onclick="closeDeleteModal()"
                            class="px-6 py-2 border border-gray-300 text-slate-gray rounded-full
                                   hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                    <form id="deleteForm" method="POST" class="inline">
                        <input type="hidden" name="_token" id="deleteToken">
                        <button type="submit"
                                class="px-6 py-2 bg-red-500 text-white rounded-full font-semibold
                                       hover:bg-red-600 transition-colors">
                            Delete Album
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let albumToDelete = null;
let deleteToken = null;

function confirmDelete(albumId, albumTitle, token) {
    albumToDelete = albumId;
    deleteToken = token;
    document.getElementById('deleteAlbumTitle').textContent = albumTitle;
    document.getElementById('deleteModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    albumToDelete = null;
    deleteToken = null;
}

// Dropdown menu functionality
function toggleDropdown(albumId) {
    // Close all other dropdowns first
    document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
        if (dropdown.id !== `dropdown-${albumId}`) {
            dropdown.classList.add('hidden');
        }
    });

    // Toggle the current dropdown
    const dropdown = document.getElementById(`dropdown-${albumId}`);
    dropdown.classList.toggle('hidden');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const dropdowns = document.querySelectorAll('[id^="dropdown-"]');
    dropdowns.forEach(dropdown => {
        const button = dropdown.previousElementSibling;
        const card = dropdown.closest('.album-card');
        if (!dropdown.contains(event.target) && !button.contains(event.target) && !card.contains(event.target)) {
            dropdown.classList.add('hidden');
        }
    });
});

// Search functionality
document.getElementById('albumSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const albumCards = document.querySelectorAll('.album-card');

    albumCards.forEach(card => {
        const title = card.dataset.title;
        const status = card.dataset.status;

        if (title.includes(searchTerm) ||
            (searchTerm === 'public' && status === 'public') ||
            (searchTerm === 'private' && status === 'private')) {
            card.style.display = 'block';
        } else if (searchTerm === '') {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
});

// Close modal on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && !document.getElementById('deleteModal').classList.contains('hidden')) {
        closeDeleteModal();
    }
});

// Set up delete form when modal opens
document.getElementById('deleteModal').addEventListener('transitionend', function() {
    if (!this.classList.contains('hidden') && albumToDelete && deleteToken) {
        const deleteForm = document.getElementById('deleteForm');
        const deleteTokenInput = document.getElementById('deleteToken');

        // Set form action
        deleteForm.action = '{{ path('app_album_delete', {'id': 'PLACEHOLDER'}) }}'.replace('PLACEHOLDER', albumToDelete);

        // Set CSRF token
        deleteTokenInput.value = deleteToken;
    }
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}
